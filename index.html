<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>William vs Schnauzers: Ultimate</title>
    <style>
        /* Fond avec texture d'herbe et police style Arcade */
        body { 
            margin: 0; overflow: hidden; 
            background: #5a8a3c url('https://www.transparenttextures.com/patterns/grass.png');
            font-family: 'Impact', sans-serif; touch-action: none; user-select: none;
        }
        #ui {
            position: absolute; top: env(safe-area-inset-top, 15px); left: 15px; right: 15px;
            display: flex; justify-content: space-between; pointer-events: none; z-index: 10;
            text-shadow: 2px 2px 4px #000;
        }
        /* Barre de vie stylis√©e */
        .health-wrapper {
            display: flex; align-items: center; gap: 10px;
        }
        .health-container {
            width: 200px; height: 20px; background: rgba(0,0,0,0.7);
            border: 3px solid #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #health-bar {
            width: 100%; height: 100%; background: linear-gradient(180deg, #ff3333, #cc0000);
            box-shadow: inset 0 2px 4px rgba(255,255,255,0.4); transition: width 0.1s ease;
        }
        /* Compteurs stylis√©s */
        .counter-box {
            background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px;
            border: 2px solid #fff; font-size: 20px; color: white; display: flex; align-items: center; gap: 8px;
        }

        /* Bouton Croquette Am√©lior√© */
        #kibble-btn {
            position: absolute; bottom: 40px; right: 30px;
            width: 85px; height: 85px; 
            background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 45px; border: 4px solid #fff; box-shadow: 0 8px 15px rgba(0,0,0,0.4);
            cursor: pointer; z-index: 20; transition: transform 0.1s;
        }
        #kibble-btn:active { transform: scale(0.9); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }

        /* Intro style "FIGHT" percutante */
        #intro-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; z-index: 50; perspective: 1000px;
        }
        #intro-text-1 { font-size: 40px; color: #aaa; margin-bottom: -20px; opacity: 0; }
        #intro-text-2 { 
            font-size: 100px; color: #ff0000; text-shadow: 5px 5px #000, 0 0 20px #ff0000; 
            transform: scale(3) rotateX(90deg); opacity: 0;
        }
        .anim-stage1 #intro-text-1 { animation: fadeIn 0.5s forwards; }
        .anim-stage2 #intro-text-2 { animation: slam 0.6s cubic-bezier(.17,.67,.38,1.43) forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes slam { 
            0% { transform: scale(5) rotateX(90deg); opacity: 0; }
            70% { transform: scale(0.9) rotateX(0deg); opacity: 1; }
            100% { transform: scale(1) rotateX(0deg); opacity: 1; }
        }

        #game-over {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 100; text-align: center;
        }
        #game-over h1 { font-size: 60px; color: #ff3333; text-shadow: 3px 3px #000; }
        .go-stats { font-size: 24px; margin: 20px 0; }
        button { 
            padding: 15px 40px; font-size: 24px; cursor: pointer; border-radius: 50px; 
            border: none; background: #ff8c00; color: white; font-family: 'Impact', sans-serif;
            box-shadow: 0 6px #cc7000; transition: all 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: 0 2px #cc7000; }
    </style>
</head>
<body>
    <div id="intro-screen">
        <div id="intro-text-1">WILLIAM :</div>
        <div id="intro-text-2">FUIS VITE !</div>
    </div>
    
    <div id="ui">
        <div class="health-wrapper">
            <span style="font-size: 28px;">‚ù§Ô∏è</span>
            <div class="health-container"><div id="health-bar"></div></div>
        </div>
        <div style="display: flex; gap: 10px;">
            <div class="counter-box">‚è±Ô∏è <span id="time-count">0s</span></div>
            <div class="counter-box">ü¶¥ <span id="k-count">10</span></div>
        </div>
    </div>

    <div id="kibble-btn">ü•©</div>

    <div id="game-over">
        <h1>L√âCH√â ! üí¶</h1>
        <div class="go-stats">Tu as surv√©cu : <span id="final-time"></span></div>
        <button onclick="location.reload()">REJOUER</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const healthBar = document.getElementById('health-bar');
        const kCountText = document.getElementById('k-count');
        const timeText = document.getElementById('time-count');
        const kibbleBtn = document.getElementById('kibble-btn');
        const introScreen = document.getElementById('intro-screen');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // √âtat du jeu
        let health = 10;
        let kibblesLeft = 10;
        let gameActive = false;
        let globalSpeed = 1.8;
        let startTime;
        let isLicked = false; // Pour l'effet d'√©claboussure

        // Personnages
        const player = { x: canvas.width/2, y: canvas.height/2, size: 60, emoji: "üßç" };
        const dogs = [
            { id: 1, x: 80, y: 80, emoji: "üêï‚Äçü¶∫", targetKibbleId: null },
            { id: 2, x: canvas.width-80, y: 80, emoji: "üêï‚Äçü¶∫", targetKibbleId: null }
        ];
        let kibbles = []; // Tableau pour g√©rer plusieurs croquettes
        let kibbleIdCounter = 0;

        // --- S√©quence d'intro ---
        window.onload = () => {
            setTimeout(() => introScreen.classList.add('anim-stage1'), 500);
            setTimeout(() => introScreen.classList.add('anim-stage2'), 1200);
            setTimeout(() => {
                introScreen.style.display = 'none';
                gameActive = true;
                startTime = Date.now();
                update();
                timerLoop();
            }, 3000);
        };

        // --- Contr√¥les ---
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        function moveHandler(e) {
            if(!gameActive) return;
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            // Le joueur suit le doigt/souris avec un l√©ger d√©calage pour qu'il soit centr√© sous le doigt
            player.x = cx - 30;
            player.y = cy - 30;
        }
        canvas.addEventListener('touchmove', moveHandler, {passive: false});
        canvas.addEventListener('mousemove', moveHandler);

        // --- Logique des Croquettes (Complexe) ---
        function dropKibble() {
            if(kibblesLeft > 0 && gameActive) {
                kibbles.push({ 
                    id: kibbleIdCounter++, 
                    x: player.x, 
                    y: player.y, 
                    timer: 240, // Dure 4 secondes
                    assignedTo: null 
                });
                kibblesLeft--;
                kCountText.innerText = kibblesLeft;
                // Petit effet visuel sur le bouton
                kibbleBtn.style.transform = "scale(1.2)";
                setTimeout(() => kibbleBtn.style.transform = "scale(1)", 100);
            }
        }
        kibbleBtn.addEventListener('mousedown', dropKibble);
        kibbleBtn.addEventListener('touchstart', (e) => { e.preventDefault(); dropKibble(); });
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') dropKibble(); });

        // Fonction pour assigner les croquettes aux chiens de mani√®re intelligente
        function assignTargets() {
            // R√©initialiser les cibles
            dogs.forEach(dog => dog.targetKibbleId = null);
            kibbles.forEach(k => k.assignedTo = null);

            // Pour chaque chien, trouver la croquette libre la plus proche
            dogs.forEach(dog => {
                let bestKibble = null;
                let minDistance = Infinity;

                kibbles.forEach(kibble => {
                    if (kibble.assignedTo === null) { // Si la croquette est libre
                        let dx = kibble.x - dog.x;
                        let dy = kibble.y - dog.y;
                        let dist = dx*dx + dy*dy; // Distance au carr√© (plus rapide)
                        if (dist < minDistance) {
                            minDistance = dist;
                            bestKibble = kibble;
                        }
                    }
                });

                // Si une croquette a √©t√© trouv√©e pour ce chien, on fait le lien
                if (bestKibble) {
                    dog.targetKibbleId = bestKibble.id;
                    bestKibble.assignedTo = dog.id;
                }
            });
        }

        // --- Timer ---
        function timerLoop() {
            if(!gameActive) return;
            let elapsed = Math.floor((Date.now() - startTime) / 1000);
            timeText.innerText = elapsed + "s";
            setTimeout(timerLoop, 1000);
        }

        // --- Boucle Principale du Jeu ---
        function update() {
            if(!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // D√©placement Clavier
            const pSpeed = 7;
            if(keys['ArrowUp']) player.y -= pSpeed;
            if(keys['ArrowDown']) player.y += pSpeed;
            if(keys['ArrowLeft']) player.x -= pSpeed;
            if(keys['ArrowRight']) player.x += pSpeed;

            // Acc√©l√©ration des chiens
            globalSpeed += 0.0008;

            // Mise √† jour des cibles
            assignTargets();

            isLicked = false; // R√©initialiser l'√©tat de l√©chage

            // --- Gestion des Chiens ---
            dogs.forEach(dog => {
                let target = player; // Cible par d√©faut : le joueur
                
                // Si le chien a une croquette assign√©e, c'est sa nouvelle cible
                if(dog.targetKibbleId !== null) {
                    target = kibbles.find(k => k.id === dog.targetKibbleId);
                    if(!target) { // S√©curit√© : si la croquette a disparu entre temps
                        target = player;
                        dog.targetKibbleId = null;
                    }
                }
                
                // Calcul du vecteur de d√©placement
                let dx = (target.x + 30) - (dog.x + 30);
                let dy = (target.y + 30) - (dog.y + 30);
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                // Le chien avance s'il n'est pas trop pr√®s de sa cible
                if(dist > 10) {
                    dog.x += (dx/dist) * globalSpeed;
                    dog.y += (dy/dist) * globalSpeed;
                }

                // Dessiner le chien avec une ombre
                ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 15;
                ctx.font = "70px serif";
                ctx.fillText(dog.emoji, dog.x, dog.y + 60);
                ctx.shadowBlur = 0;

                // Collision avec le joueur (seulement si le chien ne vise pas une croquette)
                if(dog.targetKibbleId === null && dist < 50) {
                    health -= 0.06; 
                    healthBar.style.width = Math.max(0, health * 10) + "%";
                    isLicked = true; // Active l'effet visuel
                }
            });

            // --- Gestion des Croquettes ---
            for(let i = kibbles.length - 1; i >= 0; i--) {
                let k = kibbles[i];
                ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 10; ctx.shadowOffsetY = 5;
                ctx.font = "50px serif";
                ctx.fillText("ü•©", k.x, k.y + 40);
                ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;

                k.timer--;
                // La croquette dispara√Æt si son temps est √©coul√©
                if(k.timer <= 0) {
                    kibbles.splice(i, 1);
                }
            }

            // --- Dessiner le Joueur ---
            // Ombre port√©e
            ctx.shadowColor = "rgba(0,0,0,0.6)"; ctx.shadowBlur = 20;
            ctx.font = "70px serif";
            ctx.fillText(player.emoji, player.x, player.y + 60);
            ctx.shadowBlur = 0;

            // --- Effet de L√©chage (√âclaboussures) ---
            if(isLicked) {
                ctx.font = "50px serif";
                // Affiche 3 gouttes d'eau al√©atoirement autour du joueur
                ctx.fillText("üí¶", player.x - 20 + Math.random()*20, player.y + 30 + Math.random()*20);
                ctx.fillText("üí¶", player.x + 40 + Math.random()*20, player.y + 10 + Math.random()*20);
                ctx.fillText("üí¶", player.x + 10 + Math.random()*20, player.y + 70 + Math.random()*20);
                // Petit effet de tremblement de l'√©cran
                canvas.style.transform = `translate(${Math.random()*4-2}px, ${Math.random()*4-2}px)`;
            } else {
                canvas.style.transform = "none";
            }

            // --- Fin de Partie ---
            if(health <= 0) {
                gameActive = false;
                canvas.style.transform = "none";
                document.getElementById('final-time').innerText = timeText.innerText;
                document.getElementById('game-over').style.display = 'flex';
                return;
            }

            requestAnimationFrame(update);
        }
    </script>
</body>
</html>
